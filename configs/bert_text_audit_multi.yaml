# configs/bert_text_audit_multi.yaml
# 文本审计模型配置：BERT-base + LoRA微调 + 错词标记识别 + 双任务
# 生产环境版本：完整训练配置，支持误报识别和风险分级双任务

# --- 1. 实验基本定义 ---
exp_id: "bert_text_audit_multi_task_final"                    # 实验标识：多任务版本标识，区分单任务配置
description: "文本审计双任务：误报识别(2分类) + 风险分级(5分类)。使用 LoRA 微调和错词标记。"  # 实验描述：明确双任务目标
base_config: "templates/bert_lora_template.yaml"             # 基础配置模板：继承BERT+LoRA共享配置
task_type: "multi_cls"                                        # 任务类型：多任务分类，同时处理两个相关任务

# --- 2. 数据配置 - 双任务数据格式 ---
data:
  # 数据路径配置 - 请确保数据文件包含双任务标签
  train_path: "./data/raw/bert_text_audit_multi/train.jsonl"  # 训练数据：需包含misreport和risk双标签
  dev_path: "./data/raw/bert_text_audit_multi/dev.jsonl"       # 验证数据：用于早停和双任务评估
  test_path: "./data/raw/bert_text_audit_multi/test.jsonl"   # 测试数据：最终双任务性能评估
  max_len: 256                                                # 文本最大长度：统一截断填充，保证批次处理
  
  text_col: "text"                                            # 文本字段名：数据中文本内容的列名
  
  # 双任务标签配置 - 必须同时包含两个任务的标签列
  label_col: 
    misreport: "is_misreport_label"                          # 误报标签列：0=非误报，1=误报
    risk: "risk_label"                                        # 风险标签列：1-5级风险分级
    
  # 标签取值范围 - 定义每个任务的标签空间
  label_subset: 
    misreport: [0, 1]                                        # 误报标签：二分类，0和1两个类别
    risk: [0, 1, 2, 3, 4]                                    # 风险标签：五分类，0-4对应1-5级风险
    
  # 标签映射关系 - 数字索引到可读文本的映射
  label_mapping:
    misreport: {0 : "非误报", 1 : "误报"}                  # 误报标签解释：索引到中文映射
    risk: {0 : "一级", 1 : "二级", 2 : "三级", 3 : "四级", 4 : "五级"}  # 风险等级解释

# --- 3. Tokenizer配置 - 错词标记特殊处理 ---
tokenizer:
  add_special_tokens: True                                    # 添加特殊标记：启用自定义token扩展
  special_tokens: 
    - "[ERROR]"                                               # 错误开始标记：标识文本中错词起始位置
    - "[/ERROR]"                                              # 错误结束标记：标识文本中错词结束位置  
    - "NOSUGGEST"                                             # 无建议标记：标识无需修正的词或短语
    
# --- 4. 模型架构配置 - 双任务适配 ---
model:
  dropout: 0.15                                               # 丢弃率：防止过拟合，增强模型泛化能力
  freeze_bert: True                                           # 冻结BERT：只训练LoRA和分类头，节省显存
  arch: "bert-base-chinese"                                   # 模型架构：使用BERT-base中文预训练模型
  path: "./models/bert-base-chinese"                         # 模型路径：本地预训练模型文件位置
  
  # LoRA 配置 - 低秩适配微调，平衡效果和效率
  lora:
    rank: 8                                                   # 秩大小：低秩矩阵维度，8为推荐值，平衡效果和效率
    alpha: 16                                                 # 缩放系数：控制LoRA更新幅度，通常设为rank的2倍
    dropout: 0.05                                             # 丢弃率：LoRA层随机失活，防止适配器过拟合
    target_modules: ["self.query", "self.key", "self.value"]   # 目标模块：适配注意力层的Q、K、V三个组件
    bias: "none"                                              # 偏置项：不训练偏置参数，节省显存加速训练

# --- 5. 训练超参数配置 - 双任务优化 ---
train:
  num_epochs: 14                                              # 训练轮数：充分训练确保双任务都收敛到最优
  batch_size: 20                                              # 批次大小：平衡显存占用和训练稳定性
  gradient_accumulation_steps: 3                              # 梯度累积：3步累积等效batch_size=60，提升效果
  warmup_ratio: 0.1                                           # 热身比例：10%训练步数用于学习率预热，稳定训练
  
  # 早停策略 - 基于双任务平均性能早停
  early_stopping:
    patience: 3                                               # 耐心值：连续3轮平均F1无提升则停止训练
    metric: "avg_f1"                                          # 监控指标：使用双任务平均F1分数作为早停依据
    
  # 损失权重 - 平衡双任务重要性，避免某个任务主导训练
  loss_weight: [1.0, 1.2]                                     # 权重配置：[误报任务权重1.0, 风险任务权重1.2]
  
  # 优化器配置 - 分组学习率，针对不同参数类型差异化学习
  optimizer:
    type: "AdamW"                                             # 优化器类型：AdamW，带权重衰减的正则化
    # 分组学习率：针对不同参数组件设置差异化学习率
    groups:
      bert: 2e-6                                              # BERT参数：极低学习率，轻微调整预训练权重
      lora: 1.5e-4                                            # LoRA参数：较高学习率，快速适配新任务
      classifier: 5e-4                                        # 分类头：高学习率，双任务分类器快速收敛
  
  # 学习率调度器 - 动态调整提升训练效果
  scheduler_type: "cosine"                                    # 调度类型：余弦退火，学习率先升后降平滑收敛

# --- 6. 资源调度配置 ---
resources:
  priority: "high"                                            # 任务优先级：高优先级获取计算资源
  gpus: "auto"                                                # GPU设置：自动检测并使用可用GPU设备